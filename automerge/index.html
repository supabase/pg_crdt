
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A PostgreSQL extension for CRDTs">
      
      
      
        <link rel="canonical" href="https://supabase.github.io/pg_crdt/automerge/">
      
      
        <link rel="prev" href="..">
      
      
      
      <link rel="icon" href="../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>AutoMerge - pg_crdt</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#automerge" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pg_crdt" class="md-header__button md-logo" aria-label="pg_crdt" data-md-component="logo">
      
  <img src="../assets/favicon.ico" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pg_crdt
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              AutoMerge
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/supabase/pg_crdt" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    supabase/pg_crdt
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pg_crdt" class="md-nav__button md-logo" aria-label="pg_crdt" data-md-component="logo">
      
  <img src="../assets/favicon.ico" alt="logo">

    </a>
    pg_crdt
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/supabase/pg_crdt" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    supabase/pg_crdt
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    AutoMerge
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    AutoMerge
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#casting-tofrom-jsonb" class="md-nav__link">
    <span class="md-ellipsis">
      Casting to/from jsonb
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-scalar-values" class="md-nav__link">
    <span class="md-ellipsis">
      Getting scalar values
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting scalar values">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#integers" class="md-nav__link">
    <span class="md-ellipsis">
      Integers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strings" class="md-nav__link">
    <span class="md-ellipsis">
      Strings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#doubles" class="md-nav__link">
    <span class="md-ellipsis">
      Doubles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bools" class="md-nav__link">
    <span class="md-ellipsis">
      Bools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#counters" class="md-nav__link">
    <span class="md-ellipsis">
      Counters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text" class="md-nav__link">
    <span class="md-ellipsis">
      Text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#marks" class="md-nav__link">
    <span class="md-ellipsis">
      Marks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actor-ids" class="md-nav__link">
    <span class="md-ellipsis">
      Actor Ids
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merging-documents" class="md-nav__link">
    <span class="md-ellipsis">
      Merging documents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Changes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#casting-tofrom-jsonb" class="md-nav__link">
    <span class="md-ellipsis">
      Casting to/from jsonb
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-scalar-values" class="md-nav__link">
    <span class="md-ellipsis">
      Getting scalar values
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting scalar values">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#integers" class="md-nav__link">
    <span class="md-ellipsis">
      Integers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strings" class="md-nav__link">
    <span class="md-ellipsis">
      Strings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#doubles" class="md-nav__link">
    <span class="md-ellipsis">
      Doubles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bools" class="md-nav__link">
    <span class="md-ellipsis">
      Bools
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#counters" class="md-nav__link">
    <span class="md-ellipsis">
      Counters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#text" class="md-nav__link">
    <span class="md-ellipsis">
      Text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#marks" class="md-nav__link">
    <span class="md-ellipsis">
      Marks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actor-ids" class="md-nav__link">
    <span class="md-ellipsis">
      Actor Ids
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#merging-documents" class="md-nav__link">
    <span class="md-ellipsis">
      Merging documents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Changes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="automerge">AutoMerge</h1>
<p>This documentation is also tests for the code, the examples below
show the literal output of these statements from Postgres.</p>
<p>The <code>automerge</code> extension is the first (of hopefully several) CRDT
libraries provided by the <code>pg_crdt</code> package.  The <a href="https://automerge.org/">Automerge
Library</a> provides a json-like document
format which allows concurrent changes on different devices to be
merged automatically without requiring any central server.  Changes
from different servers and sources can be applied to documents to
bring them up to date, or whole documents can be "merged" to
combine them without conflicts.</p>
<p>Some setup to make sure the extension is installed.</p>
<pre><code class="language-postgres-console">create extension if not exists automerge;
set search_path to public,automerge;
</code></pre>
<p>Let's make a test table to contain our automerge documents.</p>
<pre><code class="language-postgres-console">create table if not exists test (
    id bigserial,
    doc autodoc not null default '{}'
    );
</code></pre>
<h2 id="casting-tofrom-jsonb">Casting to/from jsonb</h2>
<p>Automerge centers around a document object called
<code>automerge.autodoc</code>.  An autodoc is a json object "like" container
for (mostly) json like types. Documents can be created by casting
an initializing a json/jsonb object to <code>autodoc</code>:</p>
<pre><code class="language-postgres-console">insert into test (doc) values ('{&quot;foo&quot;:1}') returning id \gset
select pg_typeof(doc) from test where id = :id;
┌───────────┐
│ pg_typeof │
├───────────┤
│ autodoc   │
└───────────┘
(1 row)

</code></pre>
<p>An <code>autodoc</code> instance looks like a <code>bytea</code> type, which internally
encodes the state of the document.  This casting operation supports
all the Postgres jsonb types.  jsonb doesn't have a distinction
between integers and floats, but autodoc automatically detects them
and creates the right autodoc value.</p>
<p>You can cast back to <code>jsonb</code> as well:</p>
<pre><code class="language-postgres-console">select doc::jsonb from test where id = :id;
┌────────────┐
│    doc     │
├────────────┤
│ {&quot;foo&quot;: 1} │
└────────────┘
(1 row)

</code></pre>
<p>Note that casting to jsonb is a potentially lossy operation, since
autodoc support more types of values than jsonb does, such as text
objects, counters and timestamps.  Text objects are converted to
json strings, Counters are converted to integers, and timestamps to
UTC strings.  There is no JSON input representation for text,
counters or timestamps, you must use <code>put_text</code>, <code>put_counter</code> or
<code>put_timestamp</code> (see below) to set those types explicity on
documents.</p>
<h2 id="getting-scalar-values">Getting scalar values</h2>
<p>Individual scalar values can be retrieved from an autodoc with
<code>_get</code> functions and set with <code>_put</code> functions.  These functions
take a path syntax that can traverse the document and its
sub-objects/arrays.  An object is traversed with the <code>.</code> operator
and array items are indexed with the <code>[]</code> operator:</p>
<h3 id="integers">Integers</h3>
<p>Autodoc integers are mapped to postgres 64-bit signed integers
(<code>bigint</code>).  They can be initialized from jsonb using json
integers, or put directly into an existing autdoc.</p>
<pre><code class="language-postgres-console">insert into test (doc) values ('{&quot;foo&quot;:1,&quot;far&quot;:{&quot;bar&quot;:[1,2,3]}}') returning id \gset
select get_int(doc, '.foo') from test where id = :id;
┌─────────┐
│ get_int │
├─────────┤
│       1 │
└─────────┘
(1 row)

select get_int(doc, '.far.bar[1]') from test where id = :id;
┌─────────┐
│ get_int │
├─────────┤
│       2 │
└─────────┘
(1 row)

update test set doc = put_int(doc, '.fiz', 2) where id = :id returning doc::jsonb;
┌─────────────────────────────────────────────────┐
│                       doc                       │
├─────────────────────────────────────────────────┤
│ {&quot;far&quot;: {&quot;bar&quot;: [1, 2, 3]}, &quot;fiz&quot;: 2, &quot;foo&quot;: 1} │
└─────────────────────────────────────────────────┘
(1 row)

</code></pre>
<p><code>put_int</code> (and other <code>put_</code> functions) take an optional boolean
argument <code>insert</code>.  If true, the value will be inserted after the
provided position into an array instead of overwriting it.  If the
value is not an array, the <code>insert</code> argument is ignored:</p>
<pre><code class="language-postgres-console">update test set doc = put_int(doc, '.far.bar[1]', 3, false) where id = :id returning doc::jsonb;
┌─────────────────────────────────────────────────┐
│                       doc                       │
├─────────────────────────────────────────────────┤
│ {&quot;far&quot;: {&quot;bar&quot;: [1, 3, 3]}, &quot;fiz&quot;: 2, &quot;foo&quot;: 1} │
└─────────────────────────────────────────────────┘
(1 row)

update test set doc = put_int(doc, '.far.bar[1]', 3, true) where id = :id returning doc::jsonb;
┌────────────────────────────────────────────────────┐
│                        doc                         │
├────────────────────────────────────────────────────┤
│ {&quot;far&quot;: {&quot;bar&quot;: [1, 3, 3, 3]}, &quot;fiz&quot;: 2, &quot;foo&quot;: 1} │
└────────────────────────────────────────────────────┘
(1 row)

</code></pre>
<h3 id="strings">Strings</h3>
<p>Automerge strings map to Postgres <code>text</code> type.  They can be
initialized from jsonb strings or using the same get/put API as
integers:</p>
<pre><code class="language-postgres-console">insert into test (doc) values ('{&quot;foo&quot;:&quot;fiz&quot;,&quot;bar&quot;:[&quot;one&quot;,&quot;two&quot;,&quot;three&quot;]}') returning id \gset
select get_str(doc, '.foo') from test where id = :id;
┌─────────┐
│ get_str │
├─────────┤
│ fiz     │
└─────────┘
(1 row)

select get_str(doc, '.bar[1]') from test where id = :id;
┌─────────┐
│ get_str │
├─────────┤
│ two     │
└─────────┘
(1 row)

update test set doc = put_str(doc, '.bing', 'bang') where id = :id returning doc::jsonb;
┌────────────────────────────────────────────────────────────────┐
│                              doc                               │
├────────────────────────────────────────────────────────────────┤
│ {&quot;bar&quot;: [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;], &quot;foo&quot;: &quot;fiz&quot;, &quot;bing&quot;: &quot;bang&quot;} │
└────────────────────────────────────────────────────────────────┘
(1 row)

update test set doc = put_str(doc, '.bar[1]', 'three', false) where id = :id returning doc::jsonb;
┌──────────────────────────────────────────────────────────────────┐
│                               doc                                │
├──────────────────────────────────────────────────────────────────┤
│ {&quot;bar&quot;: [&quot;one&quot;, &quot;three&quot;, &quot;three&quot;], &quot;foo&quot;: &quot;fiz&quot;, &quot;bing&quot;: &quot;bang&quot;} │
└──────────────────────────────────────────────────────────────────┘
(1 row)

update test set doc = put_str(doc, '.bar[1]', 'three', true) where id = :id returning doc::jsonb;
┌───────────────────────────────────────────────────────────────────────────┐
│                                    doc                                    │
├───────────────────────────────────────────────────────────────────────────┤
│ {&quot;bar&quot;: [&quot;one&quot;, &quot;three&quot;, &quot;three&quot;, &quot;three&quot;], &quot;foo&quot;: &quot;fiz&quot;, &quot;bing&quot;: &quot;bang&quot;} │
└───────────────────────────────────────────────────────────────────────────┘
(1 row)

</code></pre>
<h3 id="doubles">Doubles</h3>
<p>Doubles map to postgres <code>double precision</code> type, and can be
initialized from jsonb decimal numbers:</p>
<pre><code class="language-postgres-console">insert into test (doc) values ('{&quot;pi&quot;:3.14159,&quot;foo&quot;:{&quot;bar&quot;:[1.1,2.2,3.3]}}') returning id \gset
select get_double(doc, '.pi') from test where id = :id;
┌────────────┐
│ get_double │
├────────────┤
│    3.14159 │
└────────────┘
(1 row)

select get_double(doc, '.foo.bar[1]') from test where id = :id;
┌────────────┐
│ get_double │
├────────────┤
│        2.2 │
└────────────┘
(1 row)

update test set doc = put_double(doc, '.e', 2.71828) where id = :id returning doc::jsonb;
┌────────────────────────────────────────────────────────────────┐
│                              doc                               │
├────────────────────────────────────────────────────────────────┤
│ {&quot;e&quot;: 2.71828, &quot;pi&quot;: 3.14159, &quot;foo&quot;: {&quot;bar&quot;: [1.1, 2.2, 3.3]}} │
└────────────────────────────────────────────────────────────────┘
(1 row)

update test set doc = put_double(doc, '.foo.bar[1]', 3.3, false) where id = :id returning doc::jsonb;
┌────────────────────────────────────────────────────────────────┐
│                              doc                               │
├────────────────────────────────────────────────────────────────┤
│ {&quot;e&quot;: 2.71828, &quot;pi&quot;: 3.14159, &quot;foo&quot;: {&quot;bar&quot;: [1.1, 3.3, 3.3]}} │
└────────────────────────────────────────────────────────────────┘
(1 row)

update test set doc = put_double(doc, '.foo.bar[1]', 3.3, true) where id = :id returning doc::jsonb;
┌─────────────────────────────────────────────────────────────────────┐
│                                 doc                                 │
├─────────────────────────────────────────────────────────────────────┤
│ {&quot;e&quot;: 2.71828, &quot;pi&quot;: 3.14159, &quot;foo&quot;: {&quot;bar&quot;: [1.1, 3.3, 3.3, 3.3]}} │
└─────────────────────────────────────────────────────────────────────┘
(1 row)

</code></pre>
<h3 id="bools">Bools</h3>
<p>Bools map to the Postgres <code>bool</code> type:</p>
<pre><code class="language-postgres-console">insert into test (doc) values ('{&quot;foo&quot;:true,&quot;bar&quot;:[true,false,true]}') returning id \gset
select get_bool(doc, '.foo') from test where id = :id;
┌──────────┐
│ get_bool │
├──────────┤
│ t        │
└──────────┘
(1 row)

select get_bool(doc, '.bar[1]') from test where id = :id;
┌──────────┐
│ get_bool │
├──────────┤
│ f        │
└──────────┘
(1 row)

update test set doc = put_bool(doc, '.bar[1]', false) where id = :id returning doc::jsonb;
┌──────────────────────────────────────────────────┐
│                       doc                        │
├──────────────────────────────────────────────────┤
│ {&quot;bar&quot;: [true, false, false, true], &quot;foo&quot;: true} │
└──────────────────────────────────────────────────┘
(1 row)

update test set doc = put_bool(doc, '.bar[1]', true) where id = :id returning doc::jsonb;
┌────────────────────────────────────────────────────────┐
│                          doc                           │
├────────────────────────────────────────────────────────┤
│ {&quot;bar&quot;: [true, true, false, false, true], &quot;foo&quot;: true} │
└────────────────────────────────────────────────────────┘
(1 row)

</code></pre>
<h3 id="counters">Counters</h3>
<p>Automerge counters are like integers, but can be concurrently
updated and merged without losing count.</p>
<p>NOTE: Counters have no jsonb input representation, on output they
are represented as JSON integer.</p>
<pre><code class="language-postgres-console">insert into test (doc) values (put_counter('{}', '.bar', 1)) returning id \gset
select get_counter(doc, '.bar') from test where id = :id;
┌─────────────┐
│ get_counter │
├─────────────┤
│           1 │
└─────────────┘
(1 row)

update test set doc = inc_counter(doc, '.bar') where id = :id returning doc::jsonb;
┌────────────┐
│    doc     │
├────────────┤
│ {&quot;bar&quot;: 2} │
└────────────┘
(1 row)

update test set doc = inc_counter(doc, '.bar', 2) where id = :id returning doc::jsonb;
┌────────────┐
│    doc     │
├────────────┤
│ {&quot;bar&quot;: 4} │
└────────────┘
(1 row)

update test set doc = inc_counter(doc, '.bar', -2) where id = :id returning doc::jsonb;
┌────────────┐
│    doc     │
├────────────┤
│ {&quot;bar&quot;: 2} │
└────────────┘
(1 row)

</code></pre>
<h3 id="text">Text</h3>
<p>Automerge Text objects are like strings but have support for
changing ("splicing") text in and out efficiently.  Compared to
strings which are updated atomically, text values are internally
represented by an array of characters and can be modified in place.</p>
<p>NOTE: Text have no jsonb input representation, on output they are
represented as JSON string.</p>
<pre><code class="language-postgres-console">insert into test (doc) values (put_text('{}', '.foo', 'hello postgres')) returning id as text_id \gset
select get_text(doc, '.foo') from test where id = :text_id;
┌────────────────┐
│    get_text    │
├────────────────┤
│ hello postgres │
└────────────────┘
(1 row)

update test set doc = splice_text(doc, '.foo', 6, 14, 'world') where id = :text_id returning doc::jsonb;
┌────────────────────────┐
│          doc           │
├────────────────────────┤
│ {&quot;foo&quot;: &quot;hello world&quot;} │
└────────────────────────┘
(1 row)

</code></pre>
<h3 id="marks">Marks</h3>
<p>Marks are objects that span a region of a text object decorating
that region with information such as "bold" or "italic".</p>
<pre><code class="language-postgres-console">update test set doc = create_mark(doc, '.foo', 1, 2, 'bold', true) where id = :text_id;
update test set doc = create_mark(doc, '.foo', 3, 10, 'font_size', 42) where id = :text_id;
select * from get_marks((select doc from test where id = :text_id), '.foo');
┌───────────┬───────────┬─────────┬──────┐
│   name    │ start_pos │ end_pos │ val  │
├───────────┼───────────┼─────────┼──────┤
│ bold      │         1 │       2 │ true │
│ font_size │         3 │      10 │ 42   │
└───────────┴───────────┴─────────┴──────┘
(2 rows)

</code></pre>
<h2 id="actor-ids">Actor Ids</h2>
<p>Automerge supports a notion of "Actor Ids" that identify the actors
making concurrent changes to documents.  This UUID data can be get
and set with <code>get_actor_id(autodoc)</code> and <code>set_actor_id(autodoc,
uuid)</code>.  Postgres stores the last set actor id for a document which
gets preserved for future changes.  If no actor id is set,
automerge generates a random one:</p>
<pre><code class="language-postgres-console">update test set doc = set_actor_id(doc, '97131c66344c48e8b93249aabff6b2f2') where id = :text_id;
select get_actor_id(doc) from test where id = :text_id;
┌────────────────────────────────────────────────────────────────────┐
│                            get_actor_id                            │
├────────────────────────────────────────────────────────────────────┤
│ \x3937313331633636333434633438653862393332343961616266663662326632 │
└────────────────────────────────────────────────────────────────────┘
(1 row)

</code></pre>
<h2 id="merging-documents">Merging documents</h2>
<p>Documents can be merged together without conflict.  The second
argument document is merged into the first:</p>
<pre><code class="language-postgres-console">insert into test (doc) values (
    merge((select doc from test where id = :id), (select doc from test where id = :text_id))
    ) returning id as merge_id \gset
</code></pre>
<h2 id="getting-changes">Getting Changes</h2>
<p>All changes can be retrieved with the <code>get_changes()</code> function:</p>
<p>Get a change hash, message and actor_id:</p>
<pre><code class="language-postgres-console">select pg_typeof(get_change_hash(c)),
       get_change_message(c),
       pg_typeof(get_actor_id(c))
    from get_changes((select doc from test where id = :merge_id)) c;
┌───────────┬────────────────────┬───────────┐
│ pg_typeof │ get_change_message │ pg_typeof │
├───────────┼────────────────────┼───────────┤
│ bytea     │ put_counter        │ bytea     │
│ bytea     │                    │ bytea     │
│ bytea     │                    │ bytea     │
│ bytea     │                    │ bytea     │
│ bytea     │                    │ bytea     │
│ bytea     │                    │ bytea     │
│ bytea     │                    │ bytea     │
│ bytea     │                    │ bytea     │
└───────────┴────────────────────┴───────────┘
(8 rows)

</code></pre>
<p>Apply a change from one doc to another:</p>
<pre><code class="language-postgres-console">select * from get_changes('{&quot;foo&quot;:{&quot;bar&quot;:1}}') change limit 1 \gset
select apply('{&quot;baz&quot;:true}', :'change')::jsonb;
┌──────────────────────────────────┐
│              apply               │
├──────────────────────────────────┤
│ {&quot;baz&quot;: true, &quot;foo&quot;: {&quot;bar&quot;: 1}} │
└──────────────────────────────────┘
(1 row)

</code></pre>
<p>The final state of the test table:</p>
<pre><code class="language-postgres-console">select doc::jsonb from test order by id;
┌───────────────────────────────────────────────────────────────────────────┐
│                                    doc                                    │
├───────────────────────────────────────────────────────────────────────────┤
│ {&quot;foo&quot;: 1}                                                                │
│ {&quot;far&quot;: {&quot;bar&quot;: [1, 3, 3, 3]}, &quot;fiz&quot;: 2, &quot;foo&quot;: 1}                        │
│ {&quot;bar&quot;: [&quot;one&quot;, &quot;three&quot;, &quot;three&quot;, &quot;three&quot;], &quot;foo&quot;: &quot;fiz&quot;, &quot;bing&quot;: &quot;bang&quot;} │
│ {&quot;e&quot;: 2.71828, &quot;pi&quot;: 3.14159, &quot;foo&quot;: {&quot;bar&quot;: [1.1, 3.3, 3.3, 3.3]}}       │
│ {&quot;bar&quot;: [true, true, false, false, true], &quot;foo&quot;: true}                    │
│ {&quot;bar&quot;: 2}                                                                │
│ {&quot;foo&quot;: &quot;hello world&quot;}                                                    │
│ {&quot;bar&quot;: 2, &quot;foo&quot;: &quot;hello world&quot;}                                          │
└───────────────────────────────────────────────────────────────────────────┘
(8 rows)

</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Supabase
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://x.com/supabase" target="_blank" rel="noopener" title="Supabase on Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
    <a href="https://reddit.com/r/supabase" target="_blank" rel="noopener" title="Supabase on Reddit" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 256C0 114.6 114.6 0 256 0s256 114.6 256 256-114.6 256-256 256H37.1c-13.7 0-20.5-16.5-10.9-26.2L75 437C28.7 390.7 0 326.7 0 256m349.6-102.4c23.6 0 42.7-19.1 42.7-42.7s-19.1-42.7-42.7-42.7c-20.6 0-37.8 14.6-41.8 34-34.5 3.7-61.4 33-61.4 68.4v.2c-37.5 1.6-71.8 12.3-99 29.1-10.1-7.8-22.8-12.5-36.5-12.5-33 0-59.8 26.8-59.8 59.8 0 24 14.1 44.6 34.4 54.1 2 69.4 77.6 125.2 170.6 125.2s168.7-55.9 170.6-125.3c20.2-9.6 34.1-30.2 34.1-54 0-33-26.8-59.8-59.8-59.8-13.7 0-26.3 4.6-36.4 12.4-27.4-17-62.1-27.7-100-29.1v-.2c0-25.4 18.9-46.5 43.4-49.9 4.4 18.8 21.3 32.8 41.5 32.8zm-172.5 93.3c16.7 0 29.5 17.6 28.5 39.3s-13.5 29.6-30.3 29.6-31.4-8.8-30.4-30.5S160.3 247 177 247zm190.1 38.3c1 21.7-13.7 30.5-30.4 30.5s-29.3-7.9-30.3-29.6 11.8-39.3 28.5-39.3 31.2 16.6 32.1 38.3zm-48.1 56.7c-10.3 24.6-34.6 41.9-63 41.9s-52.7-17.3-63-41.9c-1.2-2.9.8-6.2 3.9-6.5 18.4-1.9 38.3-2.9 59.1-2.9s40.7 1 59.1 2.9c3.1.3 5.1 3.6 3.9 6.5"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/supabase/pg_crdt" target="_blank" rel="noopener" title="pg_crdt on GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>